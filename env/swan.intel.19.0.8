#!/bin/bash

# check for NASA Land Coupler source directory
if [ -z "${NLC_DIR}" ] ; then
  echo "ERROR: Please set NLC_DIR to root directory of cloned repository."
  exit 1
fi
if [ ! -d "${NLC_DIR}" ]; then
  echo "ERROR: ${NLC_DIR} directory does not exist."
  exit 1
fi

# load modules
module purge
module load compiler/intel/19 openmpi/4.0 LIS/7.3
module load cmake/3.20
module load python/3.9
module load git/2.29
module list

# define library paths
def_nlc_jpeg="/util/opt/libjpeg-turbo/2.0/intel/19"
def_nlc_openjpeg="/util/opt/openjpeg/2.4/intel/19"
def_nlc_eccodes="/util/opt/eccodes/2.24/intel/19.0"
def_nlc_netcdf="/util/opt/netcdf/4.7/intel/19"
def_nlc_hdf4="/util/opt/hdf4/4.2.15/intel/19"
def_nlc_hdfeos="/util/opt/hdf-eos2/2.20/intel/19"
def_nlc_hdf5="/util/opt/hdf5/1.12/intel/19"
def_nlc_modesmf="/util/opt/esmf/8.2.0/intel/19.0.1/mod/modO/Linux.intel.64.openmpi.default"
def_nlc_libesmf="/util/opt/esmf/8.2.0/intel/19.0.1/lib/libO/Linux.intel.64.openmpi.default"
def_nlc_minpack="/util/opt/minpack/19961126/intel/19/lib"
def_nlc_crtm="/util/opt/crtm/2.0/intel/19"
def_nlc_crtm_prof=""
def_nlc_cmem=""
def_nlc_lapack="/util/opt/lapack/3.9/intel/19/lib"
def_lvt_gdal="/util/opt/gdal/3.4/intel/19"
def_lvt_fortrangis="/util/opt/fortrangis/2.5/intel/19/lib"
def_ldt_libgeotiff="/util/opt/libgeotiff/1.6/intel/19/lib"

# set LIS environment variables
export DEV_ENV="LISF_7_INTEL_19_0_8"
export LIS_SRC="${NLC_DIR}/src/LISF/lis"
export LIS_ARCH="linux_ifc"
export LIS_SPMD="parallel"
export LIS_FC="mpif90"
export LIS_CC="mpicc"
export LIS_JPEG="${def_nlc_jpeg}"
export LIS_OPENJPEG="${def_nlc_openjpeg}"
export LIS_ECCODES="${def_nlc_eccodes}"
export LIS_NETCDF="${def_nlc_netcdf}"
export LIS_HDF4="${def_nlc_hdf4}"
export LIS_HDFEOS="${def_nlc_hdfeos}"
export LIS_HDF5="${def_nlc_hdf5}"
export LIS_MODESMF="${def_nlc_modesmf}"
export LIS_LIBESMF="${def_nlc_libesmf}"
export LIS_MINPACK="${def_nlc_minpack}"
export LIS_CRTM="${def_nlc_crtm}"
#export LIS_CRTM_PROF="${def_nlc_crtm_prof}"
#export LIS_CMEM="${def_nlc_cmem}"
export LIS_LAPACK="${def_nlc_lapack}"

# set LDT environment variables
export LDT_ARCH="linux_ifc"
export LDT_FC="mpif90"
export LDT_CC="mpicc"
export LDT_JPEG="${def_nlc_jpeg}"
export LDT_OPENJPEG="${def_nlc_openjpeg}"
export LDT_ECCODES="${def_nlc_eccodes}"
export LDT_NETCDF="${def_nlc_netcdf}"
export LDT_HDF4="${def_nlc_hdf4}"
export LDT_HDFEOS="${def_nlc_hdfeos}"
export LDT_HDF5="${def_nlc_hdf5}"
export LDT_MODESMF="${def_nlc_modesmf}"
export LDT_LIBESMF="${def_nlc_libesmf}"
export LDT_GDAL="${def_lvt_gdal}"
export LDT_FORTRANGIS="${def_lvt_fortrangis}"
export LDT_LIBGEOTIFF="${def_ldt_libgeotiff}"

# set LVT environment variables
export LVT_ARCH="linux_ifc"
export LVT_FC="mpif90"
export LVT_CC="mpicc"
export LVT_JPEG="${def_nlc_jpeg}"
export LVT_OPENJPEG="${def_nlc_openjpeg}"
export LVT_ECCODES="${def_nlc_eccodes}"
export LVT_NETCDF="${def_nlc_netcdf}"
export LVT_HDF4="${def_nlc_hdf4}"
export LVT_HDFEOS="${def_nlc_hdfeos}"
export LVT_HDF5="${def_nlc_hdf5}"
export LVT_MODESMF="${def_nlc_modesmf}"
export LVT_LIBESMF="${def_nlc_libesmf}"
export LVT_GDAL="${def_lvt_gdal}"
export LVT_FORTRANGIS="${def_lvt_fortrangis}"

# WRFHYDRO environment variables
export NETCDF="${def_nlc_netcdf}"
export WRF_HYDRO="1"
export SPATIAL_SOIL="1"

# NASA Land Coupler environment variables
export CMAKE_C_COMPILER="mpicc"
export CMAKE_CXX_COMPILER="mpicxx"
export CMAKE_Fortran_COMPILER="mpif90"
export NLC_LIS_INST="${NLC_DIR}/LIS-INSTALL"
export NLC_WRFHYDRO_INST="${NLC_DIR}/WRFHydro-INSTALL"
export ESMFMKFILE="${def_nlc_libesmf}/esmf.mk"
export LIBS="-lm -lsz"

