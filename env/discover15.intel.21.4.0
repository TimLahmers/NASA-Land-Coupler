#!/bin/bash

# check for NASA Land Coupler source directory
if [ -z "${NLC_DIR}" ] ; then
  echo "ERROR: Please set NLC_DIR to root directory of cloned repository."
  exit 1
fi
if [ ! -d "${NLC_DIR}" ]; then
  echo "ERROR: ${NLC_DIR} directory does not exist."
  exit 1
fi

# load modules
source /etc/profile.d/modules.sh
module purge
module load comp/gcc/11.4.0
module load comp/intel/2021.4.0
module load mpi/impi/2021.4.0
module load tview/2019.0.4
module load git/2.42.0
module load cmake/3.27.4
module load python/GEOSpyD
module list

# define library paths
def_nlc_jpeg="/discover/nobackup/projects/lis/libs/sles-12.3/jpeg/8d"
def_nlc_jasper="/discover/nobackup/projects/lis/libs/jasper/2.0.14_intel-19.1.0.166_sles12.3"
def_nlc_openjpeg="/discover/nobackup/projects/lis/libs/sles-12.3/openjpeg/2.4.0_intel-2021.4.0"
def_nlc_eccodes="/discover/nobackup/projects/lis/libs/sles-12.3/ecCodes/2.23.0_intel-2021.4.0"
def_nlc_netcdf="/discover/nobackup/projects/lis/libs/sles-12.3/netcdf/4.8.1_intel-2021.4.0"
def_nlc_hdf4="/discover/nobackup/projects/lis/libs/sles-12.3/hdf4/4.2.15_intel-2021.4.0"
def_nlc_hdfeos="/discover/nobackup/projects/lis/libs/sles-12.3/hdfeos2/3.0_intel-2021.4.0"
def_nlc_hdf5="/discover/nobackup/projects/lis/libs/sles-12.3/hdf5/1.12.1_intel-2021.4.0"
#def_nlc_modesmf="/discover/nobackup/projects/lis/libs/sles-12.3/esmf/8.1.1_intel-2021.4.0_impi-2021.4.0/mod/modO/Linux.intel.64.intelmpi.default"
#def_nlc_libesmf="/discover/nobackup/projects/lis/libs/sles-12.3/esmf/8.1.1_intel-2021.4.0_impi-2021.4.0/lib/libO/Linux.intel.64.intelmpi.default"
def_nlc_modesmf="/discover/nobackup/projects/lis/libs/esmf/8.0.1_intel-19.1.0.166_impi-20.0.0.166_sles12.3/mod/modO/Linux.intel.64.intelmpi.default"
def_nlc_libesmf="/discover/nobackup/projects/lis/libs/esmf/8.0.1_intel-19.1.0.166_impi-20.0.0.166_sles12.3/lib/libO/Linux.intel.64.intelmpi.default"
def_nlc_minpack="/discover/nobackup/projects/lis/libs/minpack/intel_11_1_038"
def_nlc_crtm="/discover/nobackup/projects/lis/libs/JCSDA_CRTM/REL-2.0.2.Surface-rev_intel_18_0_3_222"
def_nlc_crtm_prof="/discover/nobackup/projects/lis/libs/CRTM_Profile_Utility/intel_18_0_3_222"
def_nlc_cmem="/discover/nobackup/projects/lis/libs/LIS-MEM/intel_18_0_3_222"
def_nlc_lapack="/discover/nobackup/projects/lis/libs/lapack/3.6.0_intel_14_0_3_174"
def_lvt_gdal="/discover/nobackup/projects/lis/libs/sles-12.3/gdal/3.5.2_intel-2021.4.0"
def_lvt_fortrangis="/discover/nobackup/projects/lis/libs/sles-12.3/fortrangis/2.6_gdal-3.5.2_intel-2021.4.0"
def_ldt_libgeotiff="/discover/nobackup/projects/lis/libs/sles-12.3/geotiff/1.7.0_proj-9.1.0_intel-2021.4.0"

# set LIS environment variables
export DEV_ENV="LISF_7_5_INTEL_2021_4_0"
export LIS_SRC="${NLC_DIR}/src/LISF/lis"
export LIS_ARCH="linux_ifc"
export LIS_SPMD="parallel"
export LIS_FC="mpif90"
export LIS_CC="mpicc"
export LIS_JPEG="${def_nlc_jpeg}"
export LIS_OPENJPEG="${def_nlc_openjpeg}"
export LIS_ECCODES="${def_nlc_eccodes}"
export LIS_NETCDF="${def_nlc_netcdf}"
export LIS_HDF4="${def_nlc_hdf4}"
export LIS_HDFEOS="${def_nlc_hdfeos}"
export LIS_HDF5="${def_nlc_hdf5}"
export LIS_MODESMF="${def_nlc_modesmf}"
export LIS_LIBESMF="${def_nlc_libesmf}"
export LIS_MINPACK="${def_nlc_minpack}"
export LIS_CRTM="${def_nlc_crtm}"
export LIS_CRTM_PROF="${def_nlc_crtm_prof}"
export LIS_CMEM="${def_nlc_cmem}"
export LIS_LAPACK="${def_nlc_lapack}"

# set LDT environment variables
export LDT_ARCH="linux_ifc"
export LDT_FC="mpif90"
export LDT_CC="mpicc"
export LDT_JPEG="${def_nlc_jpeg}"
export LDT_OPENJPEG="${def_nlc_openjpeg}"
export LDT_ECCODES="${def_nlc_eccodes}"
export LDT_NETCDF="${def_nlc_netcdf}"
export LDT_HDF4="${def_nlc_hdf4}"
export LDT_HDFEOS="${def_nlc_hdfeos}"
export LDT_HDF5="${def_nlc_hdf5}"
export LDT_MODESMF="${def_nlc_modesmf}"
export LDT_LIBESMF="${def_nlc_libesmf}"
export LDT_GDAL="${def_lvt_gdal}"
export LDT_FORTRANGIS="${def_lvt_fortrangis}"
export LDT_LIBGEOTIFF="${def_ldt_libgeotiff}"

# set LVT environment variables
export LVT_ARCH="linux_ifc"
export LVT_FC="mpif90"
export LVT_CC="mpicc"
export LVT_JPEG="${def_nlc_jpeg}"
export LVT_OPENJPEG="${def_nlc_openjpeg}"
export LVT_ECCODES="${def_nlc_eccodes}"
export LVT_NETCDF="${def_nlc_netcdf}"
export LVT_HDF4="${def_nlc_hdf4}"
export LVT_HDFEOS="${def_nlc_hdfeos}"
export LVT_HDF5="${def_nlc_hdf5}"
export LVT_MODESMF="${def_nlc_modesmf}"
export LVT_LIBESMF="${def_nlc_libesmf}"
export LVT_GDAL="${def_lvt_gdal}"
export LVT_FORTRANGIS="${def_lvt_fortrangis}"

# WRFHYDRO environment variables
export NETCDF="${def_nlc_netcdf}"
export WRF_HYDRO="1"
export SPATIAL_SOIL="1"

# NASA Land Coupler environment variables
export CMAKE_C_COMPILER="mpicc"
export CMAKE_CXX_COMPILER="mpicxx"
export CMAKE_Fortran_COMPILER="mpif90"
export NLC_LIS_INST="${NLC_DIR}/LIS-INSTALL"
export NLC_WRFHYDRO_INST="${NLC_DIR}/WRFHydro-INSTALL"
export ESMFMKFILE="${def_nlc_libesmf}/esmf.mk"

